// swift-tools-version:5.9
// The swift-tools-version declares the minimum version of Swift required to build this package.

import PackageDescription

// See https://developer.apple.com/documentation/xcode/creating-a-standalone-swift-package-with-xcode#Make-your-Swift-package-cross-platform-compatible
let osEnvRocks: String
#if os(Linux)
osEnvRocks = "OS_LINUX"
#else
osEnvRocks = "OS_MACOSX"
#endif

let package = Package(
    name: "RocksDB",
    products: [
        // Products define the executables and libraries produced by a package, and make them visible to other packages.
        .library(
            name: "RocksDB",
            targets: ["RocksDB"]),
    ],
    dependencies: [
        // Dependencies declare other packages that this package depends on.
        // .package(url: /* package url */, from: "1.0.0"),
    ],
    targets: [
        // Targets are the basic building blocks of a package. A target can define a module or a test suite.
        // Targets can depend on other targets in this package and products from dependencies.
        .target(
            name: "librocksdb",
            exclude: [
                // Exclude because have a 'main' and the main symbol clashes (besides don't use it).
                "upstream/include/rocksdb/cache_bench_tool.h",
                "upstream/cache/cache_bench.cc",
                "upstream/db/forward_iterator_bench.cc",
                "upstream/db/range_del_aggregator_bench.cc",
                "upstream/memtable/memtablerep_bench.cc",
                "upstream/test_util/testutil_test.cc",
                "upstream/utilities/persistent_cache/persistent_cache_bench.cc",
                "upstream/table/table_reader_bench.cc",
                "upstream/utilities/persistent_cache/hash_table_bench.cc",
                "upstream/table/table_reader_bench.cc",
                "upstream/util/log_write_bench.cc",
                "upstream/util/filter_bench.cc",

                "upstream/third-party/gtest-1.8.1/fused-src/gtest/CMakeLists.txt",
                "upstream/port/README",
                "upstream/utilities/transactions/lock/range/range_tree/lib/README",
                // TODO: multi-licensed and we pick Apache? Figure it out.
                "upstream/utilities/transactions/lock/range/range_tree/lib/COPYING.APACHEv2",
                "upstream/utilities/transactions/lock/range/range_tree/lib/COPYING.AGPLv3",
                "upstream/utilities/transactions/lock/range/range_tree/lib/COPYING.GPLv2",
                // TODO: Figure out our this crc story
                "upstream/util/crc32c_ppc_asm.S",
                // Not needed. build_version.cc should have been generated by a pre-step;
                // see the adjacent README.md
                "upstream/util/build_version.cc.in",
                // No windows
                "upstream/port/win",

                // Exclude all test code; don't need it.
                "upstream/options/customizable_test.cc",
                "upstream/options/configurable_test.h",
                "upstream/options/options_test.cc",
                "upstream/options/configurable_test.cc",
                "upstream/options/options_settable_test.cc",
                "upstream/crash_test.mk",
                "upstream/tools/db_bench_tool_test.cc",
                "upstream/tools/advisor/test",
                "upstream/tools/advisor/test/input_files/test_rules.ini",
                "upstream/tools/advisor/test/test_rule_parser.py",
                "upstream/tools/advisor/test/test_db_bench_runner.py",
                "upstream/tools/advisor/test/test_db_stats_fetcher.py",
                "upstream/tools/advisor/test/test_db_log_parser.py",
                "upstream/tools/advisor/test/test_db_options_parser.py",
                "upstream/tools/regression_test.sh",
                "upstream/tools/rocksdb_dump_test.sh",
                "upstream/tools/sst_dump_test.cc",
                "upstream/tools/trace_analyzer_test.cc",
                "upstream/tools/auto_sanity_test.sh",
                "upstream/tools/io_tracer_parser_test.cc",
                "upstream/tools/ldb_test.py",
                "upstream/tools/block_cache_analyzer/block_cache_trace_analyzer_test.cc",
                "upstream/tools/block_cache_analyzer/block_cache_pysim_test.py",
                "upstream/tools/analyze_txn_stress_test.sh",
                "upstream/tools/db_crashtest.py",
                "upstream/tools/reduce_levels_test.cc",
                "upstream/tools/ldb_cmd_test.cc",
                "upstream/tools/db_sanity_test.cc",
                "upstream/memory/memory_allocator_test.cc",
                "upstream/memory/arena_test.cc",
                "upstream/cache/compressed_secondary_cache_test.cc",
                "upstream/cache/lru_cache_test.cc",
                "upstream/cache/cache_test.cc",
                "upstream/cache/cache_reservation_manager_test.cc",
                "upstream/util/rate_limiter_test.cc",
                "upstream/util/thread_list_test.cc",
                "upstream/util/work_queue_test.cc",
                "upstream/util/thread_local_test.cc",
                "upstream/util/defer_test.cc",
                "upstream/util/file_reader_writer_test.cc",
                "upstream/util/heap_test.cc",
                "upstream/util/autovector_test.cc",
                "upstream/util/crc32c_test.cc",
                "upstream/util/bloom_test.cc",
                "upstream/util/hash_test.cc",
                "upstream/util/filelock_test.cc",
                "upstream/util/timer_test.cc",
                "upstream/util/coding_test.cc",
                "upstream/util/ribbon_test.cc",
                "upstream/util/dynamic_bloom_test.cc",
                "upstream/util/repeatable_thread_test.cc",
                "upstream/util/random_test.cc",
                "upstream/util/slice_transform_test.cc",
                "upstream/util/slice_test.cc",
                "upstream/util/timer_queue_test.cc",
                "upstream/file/prefetch_test.cc",
                "upstream/file/random_access_file_reader_test.cc",
                "upstream/file/delete_scheduler_test.cc",
                "upstream/memtable/inlineskiplist_test.cc",
                "upstream/memtable/write_buffer_manager_test.cc",
                "upstream/memtable/skiplist_test.cc",
                "upstream/java/rocksjni/testable_event_listener.cc",
                "upstream/java/rocksjni/native_comparator_wrapper_test.cc",
                "upstream/java/rocksjni/rocksdb_exception_test.cc",
                "upstream/java/rocksjni/write_batch_test.cc",
                "upstream/java/src/test",
                "upstream/java/src/test/java/org/rocksdb/test",
                "upstream/docs/static/images/lost-buffered-write-recovery/test-fs-writable-file.png",
                "upstream/env/env_basic_test.cc",
                "upstream/env/env_test.cc",
                "upstream/env/io_posix_test.cc",
                "upstream/env/mock_env_test.cc",
                "upstream/utilities/simulator_cache/sim_cache_test.cc",
                "upstream/utilities/simulator_cache/cache_simulator_test.cc",
                "upstream/utilities/options/options_util_test.cc",
                "upstream/utilities/util_merge_operators_test.cc",
                "upstream/utilities/checkpoint/checkpoint_test.cc",
                "upstream/utilities/memory/memory_test.cc",
                "upstream/utilities/ttl/ttl_test.cc",
                "upstream/utilities/table_properties_collectors/compact_on_deletion_collector_test.cc",
                "upstream/utilities/option_change_migration/option_change_migration_test.cc",
                "upstream/utilities/transactions/timestamped_snapshot_test.cc",
                "upstream/utilities/transactions/write_prepared_transaction_test.cc",
                "upstream/utilities/transactions/write_unprepared_transaction_test.cc",
                "upstream/utilities/transactions/lock/point/point_lock_manager_test.cc",
                "upstream/utilities/transactions/lock/point/point_lock_manager_test.h",
                "upstream/utilities/transactions/lock/range/range_locking_test.cc",
                "upstream/utilities/transactions/transaction_test.h",
                "upstream/utilities/transactions/transaction_test.cc",
                "upstream/utilities/transactions/optimistic_transaction_test.cc",
                "upstream/utilities/transactions/write_committed_transaction_ts_test.cc",
                "upstream/utilities/cassandra/cassandra_serialize_test.cc",
                "upstream/utilities/cassandra/cassandra_row_merge_test.cc",
                "upstream/utilities/cassandra/cassandra_format_test.cc",
                "upstream/utilities/cassandra/test_utils.h",
                "upstream/utilities/cassandra/test_utils.cc",
                "upstream/utilities/cassandra/cassandra_functional_test.cc",
                "upstream/utilities/write_batch_with_index/write_batch_with_index_test.cc",
                "upstream/utilities/agg_merge/test_agg_merge.cc",
                "upstream/utilities/agg_merge/agg_merge_test.cc",
                "upstream/utilities/agg_merge/test_agg_merge.h",
                "upstream/utilities/merge_operators/string_append/stringappend_test.cc",
                "upstream/utilities/backup/backup_engine_test.cc",
                "upstream/utilities/persistent_cache/persistent_cache_test.cc",
                "upstream/utilities/persistent_cache/hash_table_test.cc",
                "upstream/utilities/persistent_cache/persistent_cache_test.h",
                "upstream/utilities/object_registry_test.cc",
                "upstream/utilities/env_mirror_test.cc",
                "upstream/utilities/env_timed_test.cc",
                "upstream/utilities/blob_db/blob_db_test.cc",
                "upstream/buckifier/rocks_test_runner.sh",
                "upstream/db_stress_tool/db_stress_test_base.cc",
                "upstream/db_stress_tool/db_stress_test_base.h",
                "upstream/table/sst_file_reader_test.cc",
                "upstream/table/cleanable_test.cc",
                "upstream/table/merger_test.cc",
                "upstream/table/cuckoo/cuckoo_table_builder_test.cc",
                "upstream/table/cuckoo/cuckoo_table_reader_test.cc",
                "upstream/table/block_based/data_block_hash_index_test.cc",
                "upstream/table/block_based/full_filter_block_test.cc",
                "upstream/table/block_based/block_test.cc",
                "upstream/table/block_based/block_based_table_reader_test.cc",
                "upstream/table/block_based/partitioned_filter_block_test.cc",
                "upstream/table/block_fetcher_test.cc",
                "upstream/table/table_test.cc",
                "upstream/build_tools/regression_build_test.sh",
                "upstream/build_tools/run_ci_db_test.ps1",
                "upstream/db/db_io_failure_test.cc",
                "upstream/db/periodic_task_scheduler_test.cc",
                "upstream/db/db_universal_compaction_test.cc",
                "upstream/db/options_file_test.cc",
                "upstream/db/db_encryption_test.cc",
                "upstream/db/db_iter_test.cc",
                "upstream/db/db_compaction_test.cc",
                "upstream/db/column_family_test.cc",
                "upstream/db/range_tombstone_fragmenter_test.cc",
                "upstream/db/db_with_timestamp_test_util.cc",
                "upstream/db/compact_files_test.cc",
                "upstream/db/table_properties_collector_test.cc",
                "upstream/db/db_basic_test.cc",
                "upstream/db/db_test2.cc",
                "upstream/db/file_indexer_test.cc",
                "upstream/db/flush_job_test.cc",
                "upstream/db/external_sst_file_test.cc",
                "upstream/db/range_del_aggregator_test.cc",
                "upstream/db/db_iter_stress_test.cc",
                "upstream/db/fault_injection_test.cc",
                "upstream/db/wal_manager_test.cc",
                "upstream/db/db_inplace_update_test.cc",
                "upstream/db/db_flush_test.cc",
                "upstream/db/db_log_iter_test.cc",
                "upstream/db/wal_edit_test.cc",
                "upstream/db/prefix_test.cc",
                "upstream/db/db_test_util.cc",
                "upstream/db/db_with_timestamp_test_util.h",
                "upstream/db/db_range_del_test.cc",
                "upstream/db/db_memtable_test.cc",
                "upstream/db/db_secondary_test.cc",
                "upstream/db/compaction/compaction_iterator_test.cc",
                "upstream/db/compaction/compaction_service_test.cc",
                "upstream/db/compaction/compaction_job_stats_test.cc",
                "upstream/db/compaction/clipping_iterator_test.cc",
                "upstream/db/compaction/tiered_compaction_test.cc",
                "upstream/db/compaction/compaction_picker_test.cc",
                "upstream/db/compaction/compaction_job_test.cc",
                "upstream/db/db_with_timestamp_compaction_test.cc",
                "upstream/db/perf_context_test.cc",
                "upstream/db/db_merge_operand_test.cc",
                "upstream/db/db_logical_block_size_cache_test.cc",
                "upstream/db/comparator_db_test.cc",
                "upstream/db/db_readonly_with_timestamp_test.cc",
                "upstream/db/version_builder_test.cc",
                "upstream/db/wide/db_wide_basic_test.cc",
                "upstream/db/wide/wide_column_serialization_test.cc",
                "upstream/db/external_sst_file_basic_test.cc",
                "upstream/db/db_statistics_test.cc",
                "upstream/db/import_column_family_test.cc",
                "upstream/db/db_compaction_filter_test.cc",
                "upstream/db/corruption_test.cc",
                "upstream/db/seqno_time_test.cc",
                "upstream/db/repair_test.cc",
                "upstream/db/db_merge_operator_test.cc",
                "upstream/db/merge_helper_test.cc",
                "upstream/db/filename_test.cc",
                "upstream/db/log_test.cc",
                "upstream/db/db_kv_checksum_test.cc",
                "upstream/db/obsolete_files_test.cc",
                "upstream/db/db_properties_test.cc",
                "upstream/db/version_set_test.cc",
                "upstream/db/db_test.cc",
                "upstream/db/listener_test.cc",
                "upstream/db/db_with_timestamp_basic_test.cc",
                "upstream/db/db_options_test.cc",
                "upstream/db/db_table_properties_test.cc",
                "upstream/db/merge_test.cc",
                "upstream/db/db_bloom_filter_test.cc",
                "upstream/db/cuckoo_table_db_test.cc",
                "upstream/db/db_rate_limiter_test.cc",
                "upstream/db/db_block_cache_test.cc",
                "upstream/db/manual_compaction_test.cc",
                "upstream/db/db_write_buffer_manager_test.cc",
                "upstream/db/db_wal_test.cc",
                "upstream/db/memtable_list_test.cc",
                "upstream/db/write_batch_test.cc",
                "upstream/db/db_iterator_test.cc",
                "upstream/db/db_write_test.cc",
                "upstream/db/error_handler_fs_test.cc",
                "upstream/db/blob/blob_counting_iterator_test.cc",
                "upstream/db/blob/db_blob_compaction_test.cc",
                "upstream/db/blob/db_blob_corruption_test.cc",
                "upstream/db/blob/blob_garbage_meter_test.cc",
                "upstream/db/blob/blob_file_builder_test.cc",
                "upstream/db/blob/blob_file_reader_test.cc",
                "upstream/db/blob/blob_source_test.cc",
                "upstream/db/blob/db_blob_basic_test.cc",
                "upstream/db/blob/db_blob_index_test.cc",
                "upstream/db/blob/blob_file_cache_test.cc",
                "upstream/db/blob/blob_file_garbage_test.cc",
                "upstream/db/blob/blob_file_addition_test.cc",
                "upstream/db/plain_table_db_test.cc",
                "upstream/db/db_sst_test.cc",
                "upstream/db/version_edit_test.cc",
                "upstream/db/db_test_util.h",
                "upstream/db/db_tailing_iter_test.cc",
                "upstream/db/deletefile_test.cc",
                "upstream/db/c_test.c",
                "upstream/db/write_controller_test.cc",
                "upstream/db/dbformat_test.cc",
                "upstream/db/db_dynamic_level_test.cc",
                "upstream/db/write_callback_test.cc",
                //"upstream/test_util",
                //"upstream/test_util/testutil.cc",
                //"upstream/test_util/secondary_cache_test_util.cc",
                //"upstream/test_util/transaction_test_util.cc",
                // "upstream/test_util/testharness.h",
                // "upstream/test_util/testharness.cc",
                //"upstream/test_util/testutil_test.cc",
                //"upstream/test_util/secondary_cache_test_util.h",
                //"upstream/test_util/testutil.h",
                //"upstream/test_util/transaction_test_util.h",
                //"upstream/third-party/gtest-1.8.1/fused-src/gtest/gtest_main.cc",
                //"upstream/third-party/gtest-1.8.1/fused-src/gtest/gtest-all.cc",
                "upstream/monitoring/statistics_test.cc",
                "upstream/monitoring/iostats_context_test.cc",
                "upstream/monitoring/stats_history_test.cc",
                "upstream/monitoring/histogram_test.cc",
                "upstream/trace_replay/block_cache_tracer_test.cc",
                "upstream/trace_replay/io_tracer_test.cc",
                "upstream/logging/auto_roll_logger_test.cc",
                "upstream/logging/env_logger_test.cc",
                "upstream/logging/event_logger_test.cc",
                "upstream/coverage/coverage_test.sh",
            ],
            sources: [
                "upstream/cache",
                "upstream/db",
                "upstream/env",
                "upstream/file",
                "upstream/include",
                "upstream/logging",
                "upstream/memory",
                "upstream/memtable",
                "upstream/monitoring",
                "upstream/options",
                "upstream/port",
                "upstream/table",
                "upstream/test_util",
                "upstream/util",
                "upstream/utilities",
                "upstream/trace_replay",
                "upstream/third-party/gtest-1.8.1/",
                // Left out:
                // tools
                // third-party
                // microbench
                // java
                // fuzz
                // db_stress_tool
                // coverage
                // cmake
            ],
            // Need to use the publicHeadersPath. We can't have it point
            // into the rocksdb git submodule checkout because we can't
            // write into it (Its a git submodule).
            publicHeadersPath: "public_headers",
            cxxSettings: [
                .headerSearchPath("upstream"),
                .headerSearchPath("upstream/include"),
                // A reference is made to the gtest.h file from the read-your-writes feature
                // https://rocksdb.org/blog/2015/02/27/write-batch-with-index.html
                // Make it so we can find the header by including below dir.
                .headerSearchPath("upstream/third-party/gtest-1.8.1/fused-src/"),
                .define("ROCKSDB_PLATFORM_POSIX"),
                .define("ROCKSDB_LIB_IO_POSIX"),
                .define("PORTABLE"),
                .define(osEnvRocks),
            ]
            // Setting the below crashes compiler.
            //swiftSettings: [.interoperabilityMode(.Cxx),
            //    .unsafeFlags(["-Xcc", "-std=c++17"]),
            //]
            ),
        .target(
            name: "RocksDB",
            dependencies: ["librocksdb"],
            cxxSettings: [
                // https://developer.apple.com/documentation/xcode/build-settings-reference#C++-and-Objective-C-Interoperability
                .define("SWIFT_OBJC_INTEROP_MODE")
            ]
            // Setting the below crashes compiler.
            //swiftSettings: [.interoperabilityMode(.Cxx),
            //    .unsafeFlags(["-Xcc", "-std=c++17"]),
            //]
            ),
        .testTarget(
            name: "RocksDBTests",
            dependencies: ["RocksDB"],
            cxxSettings: [
                // https://developer.apple.com/documentation/xcode/build-settings-reference#C++-and-Objective-C-Interoperability
                .define("SWIFT_OBJC_INTEROP_MODE")
            ]
            // Setting the below crashes compiler.
            //swiftSettings: [.interoperabilityMode(.Cxx),
            //    .unsafeFlags(["-Xcc", "-std=c++17"]),
            //]
            ),
    ],
    cxxLanguageStandard: CXXLanguageStandard.cxx17
)
